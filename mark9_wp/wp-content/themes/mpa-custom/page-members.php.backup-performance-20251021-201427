<?php get_header(); ?>

<!-- Set custom page title -->
<script>
</script>

<!-- Hero Section -->
<section class="page-hero">
    <div class="container">
        <div class="hero-content">
            <h1><?php the_title(); ?></h1>
            <p><?php 
                $hero_description = get_post_meta(get_the_ID(), '_hero_description', true);
                echo $hero_description ?: 'Meet the innovative companies and professionals driving Malaysia\'s PropTech ecosystem';
            ?></p>
        </div>
        <div class="hero-image">
            <?php if (has_post_thumbnail()) : ?>
                <?php the_post_thumbnail('large', array('alt' => get_the_title() . ' Hero')); ?>
            <?php else : ?>
                <img src="<?php echo get_template_directory_uri(); ?>/assets/members-hero.jpg" alt="<?php echo esc_attr(get_the_title()); ?>">
            <?php endif; ?>
        </div>
    </div>
</section>

<!-- Member Categories -->
<section class="member-categories">
    <div class="container">
        <div class="section-header">
            <h2>Member Categories</h2>
            <p>Diverse representation across the PropTech ecosystem organized by vertical</p>
        </div>
        <div class="categories-grid">
            <?php
            // Get vertical categories from centralized database settings
            $verticals = mpa_get_vertical_categories();
            
            // Icon mapping for each vertical
            $icons = array(
                'PLAN & CONSTRUCT' => 'fa-map-marked-alt',
                'MARKET & TRANSACT' => 'fa-exchange-alt',
                'OPERATE & MANAGE' => 'fa-cogs',
                'REINVEST, REPORT & REGENERATE' => 'fa-recycle'
            );
            
            // CSS class mapping
            $css_classes = array(
                'PLAN & CONSTRUCT' => 'plan-category',
                'MARKET & TRANSACT' => 'transact-category',
                'OPERATE & MANAGE' => 'manage-category',
                'REINVEST, REPORT & REGENERATE' => 'plan-category'
            );
            
            foreach ($verticals as $key => $vertical):
                // Count members for this vertical
                $member_count = get_posts(array(
                    'post_type' => 'mpa_member',
                    'post_status' => 'publish',
                    'meta_query' => array(
                        array(
                            'key' => '_member_vertical',
                            'value' => $key
                        )
                    ),
                    'fields' => 'ids',
                    'numberposts' => -1
                ));
                $count = count($member_count);
                
                $icon = isset($icons[$key]) ? $icons[$key] : 'fa-folder';
                $css_class = isset($css_classes[$key]) ? $css_classes[$key] : 'plan-category';
                $description = strtolower(implode(', ', $vertical['categories'])) . '.';
            ?>
            <div class="category-card <?php echo esc_attr($css_class); ?>">
                <i class="fas <?php echo esc_attr($icon); ?>"></i>
                <h3><?php echo esc_html($vertical['name']); ?></h3>
                <p><?php echo esc_html(ucfirst($description)); ?></p>
                <div class="subcategories">
                    <?php foreach ($vertical['categories'] as $category): ?>
                        <span class="subcategory"><?php echo esc_html($category); ?></span>
                    <?php endforeach; ?>
                </div>
                <div class="category-count"><?php echo $count; ?>+ Members</div>
            </div>
            <?php endforeach; ?>
        </div>
    </div>
</section>

<!-- Featured Members -->
<section class="featured-members">
    <div class="container">
        <div class="section-header">
            <h2>Featured Members</h2>
            <p>Showcasing some of our most innovative and active members</p>
        </div>
        <div class="members-grid" id="featuredMembersGrid">
            <?php
            // Query featured members
            $featured_members = new WP_Query(array(
                'post_type' => 'mpa_member',
                'posts_per_page' => -1,
                'post_status' => 'publish',
                'meta_key' => '_member_featured',
                'meta_value' => '1',
                'orderby' => 'title',
                'order' => 'ASC'
            ));
            
            if ($featured_members->have_posts()) {
                while ($featured_members->have_posts()) {
                    $featured_members->the_post();
                    $member_id = get_the_ID();
                    $categories = get_post_meta($member_id, '_member_categories', true);
                    $subcategory = get_post_meta($member_id, '_member_subcategory', true);
                    $website = get_post_meta($member_id, '_member_website', true);
                    $logo_id = get_post_thumbnail_id($member_id);
                    $logo_url = $logo_id ? wp_get_attachment_image_url($logo_id, 'large') : '';
                    $logo_url = $logo_url ? add_query_arg('v', time(), $logo_url) : '';
                    
                    // Use subcategory if available, otherwise fall back to categories
                    $display_cats = $subcategory ? $subcategory : $categories;
                    ?>
                    <div class="member-card clickable-card" onclick="window.location.href='<?php echo get_permalink(); ?>';" style="cursor: pointer;">
                        <div class="featured-tag">FEATURED</div>
                        <div class="member-logo">
                            <?php if ($logo_url): ?>
                                <a href="<?php echo get_permalink(); ?>"><img src="<?php echo esc_url($logo_url); ?>" alt="<?php echo esc_attr(get_the_title()); ?>"></a>
                            <?php else: ?>
                                <div class="member-placeholder"><?php echo esc_html(substr(get_the_title(), 0, 1)); ?></div>
                            <?php endif; ?>
                        </div>
                        <h3><a href="<?php echo get_permalink(); ?>" style="color: inherit; text-decoration: none;"><?php the_title(); ?></a></h3>
                        <?php if ($display_cats): ?>
                        <div class="member-categories">
                            <?php
                            $cats_array = array_map('trim', explode(',', $display_cats));
                            $limited_cats = array_slice($cats_array, 0, 2);
                            foreach ($limited_cats as $cat) {
                                echo '<span class="member-category">' . esc_html($cat) . '</span>';
                            }
                            ?>
                        </div>
                        <?php endif; ?>
                        <p class="member-description"><?php echo wp_strip_all_tags(get_the_content()); ?></p>
                        <div class="member-actions" onclick="event.stopPropagation();">
                            <a href="<?php echo get_permalink(); ?>" class="btn-primary" style="margin-right: 10px;">View Profile</a>
                            <?php if ($website): ?>
                            <a href="<?php echo esc_url($website); ?>" class="btn-outline" target="_blank" rel="noopener">View Website</a>
                            <?php endif; ?>
                        </div>
                    </div>
                    <?php
                }
                wp_reset_postdata();
            } else {
                echo '<p>No featured members yet. Select members to feature in the WordPress admin.</p>';
            }
            ?>
        </div>
    </div>
</section>
<!-- Member Benefits -->
<section class="member-benefits">
    <div class="container">
        <div class="section-header">
            <h2>Member Benefits</h2>
            <p>Exclusive advantages for MPA members</p>
        </div>
        <div class="benefits-grid">
            <div class="benefit-card">
                <i class="fas fa-calendar-alt"></i>
                <h3>Event Access</h3>
                <p>Priority registration and discounted rates for all MPA events, workshops, and conferences.</p>
            </div>
            <div class="benefit-card">
                <i class="fas fa-users"></i>
                <h3>Networking</h3>
                <p>Connect with industry leaders, investors, and fellow PropTech professionals through our exclusive networking events.</p>
            </div>
            <div class="benefit-card">
                <i class="fas fa-lightbulb"></i>
                <h3>Innovation Showcase</h3>
                <p>Opportunities to showcase your products and innovations to the Malaysian PropTech community.</p>
            </div>
            <div class="benefit-card">
                <i class="fas fa-graduation-cap"></i>
                <h3>Education & Training</h3>
                <p>Access to educational resources, training programs, and industry insights to stay ahead of the curve.</p>
            </div>
            <div class="benefit-card">
                <i class="fas fa-handshake"></i>
                <h3>Partnership Opportunities</h3>
                <p>Connect with potential partners, clients, and collaborators within the MPA ecosystem.</p>
            </div>
            <div class="benefit-card">
                <i class="fas fa-bullhorn"></i>
                <h3>Advocacy & Representation</h3>
                <p>Your voice represented in industry discussions and policy-making processes.</p>
            </div>
        </div>
    </div>
</section>

<!-- Member Directory -->
<section class="member-directory">
    <div class="container">
        <div class="section-header">
            <h2>Member Directory</h2>
            <p>Search and connect with our diverse member network</p>
        </div>
        <div class="directory-search">
            <div class="search-container">
                <input type="text" placeholder="Search members by name, category, or technology...">
                <button class="search-btn"><i class="fas fa-search"></i></button>
            </div>
            <div class="filter-options">
                <select class="vertical-filter">
                    <option value="">All Verticals</option>
                    <option value="plan">PLAN</option>
                    <option value="construct">CONSTRUCT</option>
                    <option value="transact">TRANSACT</option>
                    <option value="manage">MANAGE</option>
                </select>
                <select class="category-filter">
                    <option value="">All Subcategories</option>
                    <!-- PLAN Subcategories -->
                    <option value="property-development">Property Development</option>
                    <option value="mapping">Mapping</option>
                    <option value="ar-vr">AR & VR</option>
                    <option value="smart-cities">Smart Cities</option>
                    <!-- CONSTRUCT Subcategories -->
                    <option value="contech">ConTech</option>
                    <option value="renovation-tech">Renovation Tech</option>
                    <option value="iot">IoT</option>
                    <option value="smart-homes">Smart Homes</option>
                    <!-- TRANSACT Subcategories -->
                    <option value="property-marketplace">Property Marketplace</option>
                    <option value="rental-marketplace">Rental Marketplace</option>
                    <option value="fintech">Fintech</option>
                    <option value="crowdfunding">Crowdfunding</option>
                    <option value="mortgages">Mortgages</option>
                    <option value="legal-tech">Legal Tech</option>
                    <!-- MANAGE Subcategories -->
                    <option value="property-management">Property Management</option>
                    <option value="tenant-management">Tenant Management</option>
                    <option value="sales-booking">Sales & Booking</option>
                    <option value="property-community">Property Community</option>
                    <option value="big-data">Big Data</option>
                    <option value="ai">AI, DL & ML</option>
                    <option value="blockchain">Blockchain</option>
                </select>
            </div>
        </div>
        <div class="directory-grid">
            <?php
            // Query all members dynamically
            $members_query = new WP_Query(array(
                'post_type' => 'mpa_member',
                'posts_per_page' => -1,
                'post_status' => 'publish',
                'orderby' => 'title',
                'order' => 'ASC'
            ));
            
            if ($members_query->have_posts()) {
                while ($members_query->have_posts()) {
                    $members_query->the_post();
                    $member_id = get_the_ID();
                    $categories = get_post_meta($member_id, '_member_categories', true);
                    $website = get_post_meta($member_id, '_member_website', true);
                    $logo_id = get_post_thumbnail_id($member_id);
                    $logo_url = $logo_id ? wp_get_attachment_image_url($logo_id, 'large') : '';
                    $logo_url = $logo_url ? add_query_arg('v', time(), $logo_url) : '';
                    $data_cats = strtolower(str_replace(',', ' ', str_replace(', ', ' ', $categories)));
                    ?>
            <div class="directory-item clickable-card" data-categories="<?php echo esc_attr($data_cats); ?>" onclick="window.location.href='<?php echo get_permalink(); ?>';" style="cursor: pointer;">
                <div class="member-logo">
                    <?php if ($logo_url): ?>
                        <a href="<?php echo get_permalink(); ?>"><img src="<?php echo esc_url($logo_url); ?>" alt="<?php echo esc_attr(get_the_title()); ?>"></a>
                    <?php else: ?>
                        <div class="member-placeholder"><?php echo esc_html(substr(get_the_title(), 0, 1)); ?></div>
                    <?php endif; ?>
                </div>
                <div class="member-info">
                    <h3><a href="<?php echo get_permalink(); ?>" style="color: inherit; text-decoration: none;"><?php the_title(); ?></a></h3>
                    <?php if ($categories): ?>
                    <div class="member-categories">
                        <?php
                        $cats_array = array_map('trim', explode(',', $categories));
                        foreach ($cats_array as $cat) {
                            echo '<span class="member-category">' . esc_html($cat) . '</span>';
                        }
                        ?>
                    </div>
                    <?php endif; ?>
                    <p class="member-description"><?php echo wp_strip_all_tags(get_the_content()); ?></p>
                </div>
                <div class="member-actions" onclick="event.stopPropagation();">
                    <a href="<?php echo get_permalink(); ?>" class="btn-primary" style="margin-right: 10px;">View Profile</a>
                    <?php if ($website): ?>
                    <a href="<?php echo esc_url($website); ?>" class="btn-outline" target="_blank" rel="noopener">View Website</a>
                    <?php endif; ?>
                </div>
            </div>
                    <?php
                }
                wp_reset_postdata();
            }
            ?>
        </div>
    </div>
</section>


<!-- Join CTA -->
<section class="join-cta">
    <div class="container">
        <div class="cta-content">
            <h2>Ready to Join Malaysia's Leading PropTech Community?</h2>
            <p>Connect with innovative companies, access exclusive benefits, and be part of the digital transformation of Malaysia's property industry.</p>
            <div class="cta-buttons">
                <a href="<?php echo esc_url(home_url('/join/')); ?>" class="btn-primary">Become a Member</a>
                <a href="<?php echo esc_url(home_url('/membership/')); ?>" class="btn-outline">Learn More</a>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Member Directory Search and Filter Functionality
    const searchInput = document.querySelector('.directory-search input');
    const searchBtn = document.querySelector('.search-btn');
    const verticalFilter = document.querySelector('.vertical-filter');
    const categoryFilter = document.querySelector('.category-filter');
    const directoryItems = document.querySelectorAll('.directory-item');

    function filterMembers() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedVertical = verticalFilter.value;
        const selectedCategory = categoryFilter.value;

        directoryItems.forEach(item => {
            const memberName = item.querySelector('h3').textContent.toLowerCase();
            const memberDescription = item.querySelector('.member-description').textContent.toLowerCase();
            const memberCategories = item.getAttribute('data-categories');
            
            let showItem = true;

            // Search filter
            if (searchTerm && !memberName.includes(searchTerm) && !memberDescription.includes(searchTerm)) {
                showItem = false;
            }

            // Category filter
            if (selectedCategory && !memberCategories.includes(selectedCategory)) {
                showItem = false;
            }

            // Vertical filter (simplified - you can enhance this based on your categorization)
            if (selectedVertical) {
                // Add logic to map verticals to categories if needed
            }

            item.style.display = showItem ? 'block' : 'none';
        });
    }

    // Event listeners
    searchInput.addEventListener('input', filterMembers);
    searchBtn.addEventListener('click', filterMembers);
    verticalFilter.addEventListener('change', filterMembers);
    categoryFilter.addEventListener('change', filterMembers);
});
</script>

<?php get_footer(); ?>